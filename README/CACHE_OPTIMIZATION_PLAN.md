# ğŸ’¡ Agent B ç¼“å­˜ä¼˜åŒ–æ–¹æ¡ˆï¼šå•†æˆ·è‡ªå®šä¹‰çƒ­é—¨é—®é¢˜

> **æ ¸å¿ƒæ€æƒ³**: è®©å•†æˆ·è‡ªå·±æ ‡è®°çƒ­é—¨é—®é¢˜ï¼Œæ¯” AI è‡ªåŠ¨åˆ¤æ–­æ›´å‡†ç¡®ã€æ›´çœæˆæœ¬

---

## ğŸ¯ **å½“å‰å®ç° vs ä¼˜åŒ–æ–¹æ¡ˆ**

### å½“å‰å®ç° (context-pool.ts:163-209)

```typescript
// Agent B æŸ¥ç¼“å­˜
const cachedAnswer = await contextPool.findSimilarAnswer(
  merchantId,
  userId,      // âœ… æ­£ç¡®ï¼šç”¨UUIDæŸ¥è¯¥ç”¨æˆ·çš„å†å²
  sessionId,
  query
);

// Context Pool å†…éƒ¨é€»è¾‘
async findSimilarAnswer(merchantId, userId, sessionId, question) {
  const key = this.getKey(merchantId, userId, sessionId);
  // key = "ctx:dongli:user123:session"

  // 1. æŸ¥è¯¥ç”¨æˆ·çš„24hå†å² âœ…
  const items = await this.redis.lrange(key, 0, -1);

  // 2. éå†æŸ¥æ‰¾ç›¸ä¼¼é—®é¢˜
  for (let i = turns.length - 1; i >= 0; i--) {
    const turn = turns[i];
    if (turn.role === "user") {
      const similarity = this.calculateSimilarity(question, turn.content);
      if (similarity > 0.8) {
        return nextTurn.content;  // è¿”å›å†å²ç­”æ¡ˆ
      }
    }
  }
}
```

**é—®é¢˜**:

- âŒ åªæŸ¥è¯¥ç”¨æˆ·çš„å†å² (æ–°ç”¨æˆ·æŸ¥ä¸åˆ°)
- âŒ ç›¸ä¼¼åº¦è®¡ç®—ç®€å• (å¯èƒ½ä¸å‡†)
- âŒ æ²¡æœ‰åˆ©ç”¨å•†æˆ·çš„çƒ­é—¨é—®é¢˜

---

## ğŸš€ **ä¼˜åŒ–æ–¹æ¡ˆï¼šä¸¤å±‚ç¼“å­˜**

### ç¬¬ä¸€å±‚ï¼šç”¨æˆ·å†å²ç¼“å­˜ (å½“å‰å·²æœ‰)

```typescript
// 1. å…ˆæŸ¥è¯¥ç”¨æˆ·çš„24hå†å²
const userCachedAnswer = await contextPool.findSimilarAnswer(
  merchantId,
  userId, // âœ… ç”¨UUIDæŸ¥è¯¥ç”¨æˆ·çš„ä¸Šä¸‹æ–‡
  sessionId,
  query
);

if (userCachedAnswer) {
  console.log(`[Bå“¥] âš¡ ç”¨æˆ·å†å²ç¼“å­˜å‘½ä¸­`);
  return userCachedAnswer;
}
```

**ç”¨é€”**:

- è€ç”¨æˆ·é—®é‡å¤é—®é¢˜ â†’ ç›´æ¥è¿”å›å†å²ç­”æ¡ˆ
- æˆæœ¬: 0 å…ƒ (Redis æŸ¥è¯¢)

---

### ç¬¬äºŒå±‚ï¼šå•†æˆ·çƒ­é—¨é—®é¢˜ç¼“å­˜ (æ–°å¢)

```typescript
// 2. æœªå‘½ä¸­ç”¨æˆ·å†å²ï¼ŒæŸ¥å•†æˆ·çƒ­é—¨é—®é¢˜
const hotAnswer = await this.checkMerchantHotQuestions(merchantId, query);

if (hotAnswer) {
  console.log(`[Bå“¥] ğŸ”¥ å•†æˆ·çƒ­é—¨é—®é¢˜å‘½ä¸­`);
  return hotAnswer;
}
```

**æ•°æ®æ¥æº**: å•†æˆ·åœ¨åå°æ ‡è®°çš„çƒ­é—¨é—®é¢˜

```json
// server/merchant/dongli/hot-questions.json
{
  "merchantId": "dongli",
  "hotQuestions": [
    {
      "id": "hot_001",
      "question": "é—¨ç¥¨å¤šå°‘é’±",
      "keywords": ["é—¨ç¥¨", "ä»·æ ¼", "å¤šå°‘é’±", "ç¥¨", "æ”¶è´¹"],
      "answer": "æˆäººç¥¨60å…ƒ/äººï¼Œå­¦ç”Ÿç¥¨30å…ƒ/äººï¼ˆéœ€å‡­å­¦ç”Ÿè¯ï¼‰ï¼Œ60å²ä»¥ä¸Šè€äººå…è´¹ï¼ˆéœ€å‡­èº«ä»½è¯ï¼‰ã€‚",
      "hitCount": 1523, // å‘½ä¸­æ¬¡æ•°ï¼ˆè‡ªåŠ¨ç»Ÿè®¡ï¼‰
      "lastUpdated": "2026-01-15"
    },
    {
      "id": "hot_002",
      "question": "å¼€æ”¾æ—¶é—´",
      "keywords": ["å¼€æ”¾", "æ—¶é—´", "å‡ ç‚¹", "è¥ä¸š"],
      "answer": "æ¯å¤©8:00-17:30ï¼ŒèŠ‚å‡æ—¥å»¶é•¿è‡³18:00ã€‚",
      "hitCount": 892,
      "lastUpdated": "2026-01-15"
    }
  ]
}
```

**å•†æˆ·æ“ä½œæµç¨‹**:

1. åå°æŸ¥çœ‹"æŠ¥ç¼ºåˆ—è¡¨" (Agent D ç»Ÿè®¡çš„æœªæ‰¾åˆ°é—®é¢˜)
2. é€‰æ‹©é«˜é¢‘é—®é¢˜ â†’ ç‚¹å‡»"æ·»åŠ åˆ°çƒ­é—¨é—®é¢˜"
3. å¡«å†™æ ‡å‡†ç­”æ¡ˆ â†’ ä¿å­˜
4. ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæ•ˆ â†’ ä¸‹æ¬¡ç›´æ¥å‘½ä¸­

---

## ğŸ’° **æˆæœ¬å¯¹æ¯”**

### æ–¹æ¡ˆ 1: çº¯ AI åˆ¤æ–­ (ä¼ ç»Ÿæ–¹æ¡ˆ)

```
ç”¨æˆ·é—®: "é—¨ç¥¨å¤šå°‘é’±?"
  â†“
æ²¡æœ‰ç¼“å­˜ â†’ è°ƒç”¨AIç†è§£ (0.001å…ƒ)
  â†“
AIæ£€ç´¢çŸ¥è¯†åº“ (0.001å…ƒ)
  â†“
AIç”Ÿæˆå›å¤ (0.001å…ƒ)
  â†“
æ€»æˆæœ¬: 0.003å…ƒ/æ¬¡
1000æ¬¡ = 3å…ƒ
```

### æ–¹æ¡ˆ 2: ç”¨æˆ·å†å²ç¼“å­˜ (å½“å‰å®ç°)

```
è€ç”¨æˆ·é—®: "é—¨ç¥¨å¤šå°‘é’±?" (ç¬¬2æ¬¡é—®)
  â†“
æŸ¥ç”¨æˆ·å†å² â†’ å‘½ä¸­ âœ…
  â†“
ç›´æ¥è¿”å›å†å²ç­”æ¡ˆ
  â†“
æ€»æˆæœ¬: 0å…ƒ
å‘½ä¸­ç‡: çº¦30% (è€ç”¨æˆ·é‡å¤é—®é¢˜)
```

### æ–¹æ¡ˆ 3: å•†æˆ·çƒ­é—¨é—®é¢˜ (ä¼˜åŒ–æ–¹æ¡ˆ)

```
æ–°ç”¨æˆ·é—®: "é—¨ç¥¨å¤šå°‘é’±?" (ç¬¬1æ¬¡é—®)
  â†“
æŸ¥ç”¨æˆ·å†å² â†’ æœªå‘½ä¸­
  â†“
æŸ¥å•†æˆ·çƒ­é—¨é—®é¢˜ â†’ å‘½ä¸­ âœ…
  â†“
ç›´æ¥è¿”å›æ ‡å‡†ç­”æ¡ˆ
  â†“
æ€»æˆæœ¬: 0å…ƒ
å‘½ä¸­ç‡: çº¦50% (æ–°ç”¨æˆ·å¸¸è§é—®é¢˜)
```

### ç»¼åˆæ•ˆæœ

```
1000æ¬¡æŸ¥è¯¢:
  - 300æ¬¡ å‘½ä¸­ç”¨æˆ·å†å² (30%) â†’ æˆæœ¬0å…ƒ
  - 500æ¬¡ å‘½ä¸­å•†æˆ·çƒ­é—¨ (50%) â†’ æˆæœ¬0å…ƒ
  - 200æ¬¡ éœ€è¦AIå¤„ç† (20%) â†’ æˆæœ¬0.6å…ƒ

æ€»æˆæœ¬: 0.6å…ƒ (çœäº†80%)
```

---

## ğŸ› ï¸ **å®ç°æ–¹æ¡ˆ**

### 1. æ•°æ®ç»“æ„

```typescript
// server/types.ts
interface HotQuestion {
  id: string;
  question: string;
  keywords: string[];
  answer: string;
  hitCount: number;
  lastUpdated: string;
  enabled: boolean;
}

interface MerchantHotQuestions {
  merchantId: string;
  hotQuestions: HotQuestion[];
  updatedAt: number;
}
```

### 2. Agent B æŸ¥è¯¢é€»è¾‘

```typescript
// server/agents/agent-b.ts
private async handleInput(msg: Message) {
  const { merchantId, userId, sessionId } = msg;
  const query = String(data.refinedQuestion || data.input || "");

  const startTime = Date.now();

  // ===== ç¬¬ä¸€å±‚: ç”¨æˆ·å†å²ç¼“å­˜ =====
  const userCached = await contextPool.findSimilarAnswer(
    merchantId,
    userId,      // âœ… ç”¨UUIDæŸ¥è¯¥ç”¨æˆ·çš„å†å²
    sessionId,
    query
  );

  if (userCached) {
    console.log(`[Bå“¥] âš¡ ç”¨æˆ·å†å²ç¼“å­˜å‘½ä¸­`);
    await this.replyUser(msg, userCached, "user_cache", Date.now() - startTime);
    return;
  }

  // ===== ç¬¬äºŒå±‚: å•†æˆ·çƒ­é—¨é—®é¢˜ =====
  const hotAnswer = await this.checkMerchantHotQuestions(merchantId, query);

  if (hotAnswer) {
    console.log(`[Bå“¥] ğŸ”¥ å•†æˆ·çƒ­é—¨é—®é¢˜å‘½ä¸­`);
    await this.replyUser(msg, hotAnswer, "hot_question", Date.now() - startTime);

    // æ›´æ–°å‘½ä¸­æ¬¡æ•°
    await this.incrementHotQuestionHit(merchantId, hotAnswer.id);
    return;
  }

  // ===== ç¬¬ä¸‰å±‚: æŸ¥çŸ¥è¯†åº“ (Agent C) =====
  console.log(`[Bå“¥] ğŸ“š æŸ¥è¯¢çŸ¥è¯†åº“`);
  const answer = await this.queryC(msg);
  // ...
}

/**
 * æ£€æŸ¥å•†æˆ·çƒ­é—¨é—®é¢˜
 */
private async checkMerchantHotQuestions(
  merchantId: string,
  query: string
): Promise<{ id: string; answer: string } | null> {
  try {
    const hotQuestionsPath = path.join(
      process.cwd(),
      'server',
      'merchant',
      merchantId,
      'hot-questions.json'
    );

    const content = await fs.readFile(hotQuestionsPath, 'utf-8');
    const data = JSON.parse(content) as MerchantHotQuestions;

    const queryLower = query.toLowerCase();

    // éå†çƒ­é—¨é—®é¢˜ï¼ŒåŒ¹é…å…³é”®è¯
    for (const hot of data.hotQuestions) {
      if (!hot.enabled) continue;

      // æ£€æŸ¥å…³é”®è¯åŒ¹é…
      for (const keyword of hot.keywords) {
        if (queryLower.includes(keyword.toLowerCase())) {
          return {
            id: hot.id,
            answer: hot.answer
          };
        }
      }
    }

    return null;
  } catch (error) {
    console.error(`[Bå“¥] çƒ­é—¨é—®é¢˜æŸ¥è¯¢å¤±è´¥:`, error);
    return null;
  }
}
```

### 3. åå°ç®¡ç†ç•Œé¢

```typescript
// åå°æ–°å¢åŠŸèƒ½ï¼šçƒ­é—¨é—®é¢˜ç®¡ç†
ç•Œé¢å¸ƒå±€:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ”¥ çƒ­é—¨é—®é¢˜ç®¡ç†                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                    â”‚
  â”‚ [ğŸ“Š æŸ¥çœ‹æŠ¥ç¼ºåˆ—è¡¨] (æ¥è‡ªAgent D)    â”‚
  â”‚                                    â”‚
  â”‚ é«˜é¢‘æœªæ‰¾åˆ°é—®é¢˜:                    â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚ â”‚ 1. "é—¨ç¥¨å¤šå°‘é’±" - 152æ¬¡       â”‚  â”‚
  â”‚ â”‚    [â• æ·»åŠ åˆ°çƒ­é—¨é—®é¢˜]        â”‚  â”‚
  â”‚ â”‚                              â”‚  â”‚
  â”‚ â”‚ 2. "æ€ä¹ˆå»" - 89æ¬¡            â”‚  â”‚
  â”‚ â”‚    [â• æ·»åŠ åˆ°çƒ­é—¨é—®é¢˜]        â”‚  â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                    â”‚
  â”‚ å½“å‰çƒ­é—¨é—®é¢˜:                      â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚ â”‚ ID: hot_001                  â”‚  â”‚
  â”‚ â”‚ é—®é¢˜: é—¨ç¥¨å¤šå°‘é’±              â”‚  â”‚
  â”‚ â”‚ å…³é”®è¯: é—¨ç¥¨, ä»·æ ¼, å¤šå°‘é’±... â”‚  â”‚
  â”‚ â”‚ ç­”æ¡ˆ: æˆäººç¥¨60å…ƒ...           â”‚  â”‚
  â”‚ â”‚ å‘½ä¸­: 1523æ¬¡                  â”‚  â”‚
  â”‚ â”‚ [ç¼–è¾‘] [åˆ é™¤] [ç¦ç”¨]         â”‚  â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ **ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡æ›´å¥½**

### 1. **å•†æˆ·æœ€æ‡‚è‡ªå·±çš„ä¸šåŠ¡**

```
AIåˆ¤æ–­çƒ­é—¨é—®é¢˜:
  âŒ å¯èƒ½åˆ¤æ–­é”™è¯¯
  âŒ éœ€è¦å¤§é‡æ•°æ®è®­ç»ƒ
  âŒ æˆæœ¬é«˜

å•†æˆ·è‡ªå·±æ ‡è®°:
  âœ… 100%å‡†ç¡®
  âœ… ç«‹å³ç”Ÿæ•ˆ
  âœ… æˆæœ¬0å…ƒ
```

### 2. **ç­”æ¡ˆè´¨é‡æ›´é«˜**

```
AIç”Ÿæˆç­”æ¡ˆ:
  âŒ å¯èƒ½ä¸å‡†ç¡®
  âŒ å¯èƒ½ä¸ç¬¦åˆå•†æˆ·è¦æ±‚
  âŒ éœ€è¦äººå·¥å®¡æ ¸

å•†æˆ·è‡ªå·±å†™ç­”æ¡ˆ:
  âœ… 100%å‡†ç¡®
  âœ… ç¬¦åˆå•†æˆ·é£æ ¼
  âœ… æ— éœ€å®¡æ ¸
```

### 3. **æŒç»­ä¼˜åŒ–**

```
å•†æˆ·å¯ä»¥:
  âœ… æŸ¥çœ‹å‘½ä¸­æ¬¡æ•° â†’ çŸ¥é“å“ªäº›é—®é¢˜æœ€å¸¸è§
  âœ… æ›´æ–°ç­”æ¡ˆ â†’ éšæ—¶è°ƒæ•´
  âœ… ç¦ç”¨è¿‡æ—¶é—®é¢˜ â†’ ä¿æŒç­”æ¡ˆæ–°é²œ
  âœ… ä»æŠ¥ç¼ºåˆ—è¡¨æ·»åŠ  â†’ æŒç»­å®Œå–„
```

---

## ğŸŒŸ **æ€»ç»“**

### ä¼˜åŒ–åçš„ä¸‰å±‚ç¼“å­˜

```
ç”¨æˆ·æé—®
  â†“
ç¬¬ä¸€å±‚: ç”¨æˆ·å†å²ç¼“å­˜ (30%å‘½ä¸­)
  - ç”¨UUIDæŸ¥è¯¥ç”¨æˆ·çš„24hå†å²
  - è€ç”¨æˆ·é‡å¤é—®é¢˜ â†’ 0æˆæœ¬
  â†“ æœªå‘½ä¸­
ç¬¬äºŒå±‚: å•†æˆ·çƒ­é—¨é—®é¢˜ (50%å‘½ä¸­)
  - å•†æˆ·è‡ªå·±æ ‡è®°çš„å¸¸è§é—®é¢˜
  - æ–°ç”¨æˆ·å¸¸è§é—®é¢˜ â†’ 0æˆæœ¬
  â†“ æœªå‘½ä¸­
ç¬¬ä¸‰å±‚: çŸ¥è¯†åº“æ£€ç´¢ (20%éœ€è¦)
  - Agent C æ£€ç´¢çŸ¥è¯†åº“
  - å¤æ‚é—®é¢˜ â†’ å°æˆæœ¬
```

### æˆæœ¬èŠ‚çœ

```
ä¼ ç»Ÿæ–¹æ¡ˆ: 1000æ¬¡ = 3å…ƒ
ä¼˜åŒ–æ–¹æ¡ˆ: 1000æ¬¡ = 0.6å…ƒ
èŠ‚çœ: 80%
```

### ä½“éªŒæå‡

```
âœ… å“åº”æ›´å¿« (ç¼“å­˜ç›´æ¥è¿”å›)
âœ… ç­”æ¡ˆæ›´å‡† (å•†æˆ·è‡ªå·±å†™çš„)
âœ… æŒç»­ä¼˜åŒ– (å•†æˆ·å¯ä»¥éšæ—¶è°ƒæ•´)
```

---

**è¿™å°±æ˜¯ç”¨è®¾è®¡å»å‡‘ï¼Œè€Œä¸æ˜¯çƒ§é’±ï¼** ğŸ¯
