# 📋 项目待办清单与工作计划

> **更新时间**: 2026-01-16  
> **当前状态**: ✅ 核心功能完成，进入优化阶段

---

## ✅ 已完成的工作 (100%)

### P0 - 核心功能

- [x] **Agent 系统** (4 个 Agent 全部完成)

  - [x] Agent A - 意图识别 + ASR
  - [x] Agent B - 决策中心 + 两层缓存
  - [x] Agent C - 知识库检索
  - [x] Agent D - 监控录像

- [x] **数据持久化**

  - [x] Redis (Dragonfly) - Context Pool 24h 缓存
  - [x] MongoDB - 用户日志、知识库、配置

- [x] **API 路由** (15 个端点)

  - [x] 对话相关 (3 个)
  - [x] 监控相关 (3 个)
  - [x] 热门问题 (6 个)
  - [x] 知识库 (3 个)

- [x] **前端页面**

  - [x] 聊天页面 (SimpleChatPage)
  - [x] 后台管理 (Admin Layout)
  - [x] 监控面板 (MonitorPage)
  - [x] 知识库管理 (KnowledgePage)
  - [x] 配置生成器 (ConfigGeneratorPage)

- [x] **代码质量**
  - [x] Lint 0 错误
  - [x] TypeScript 0 错误
  - [x] 核心文件注释完善

---

## 🎯 待完成的工作

### P1 - 重要功能 (推荐完成)

#### 1. 语音功能完整测试 ⏳

**当前状态**: 代码已实现，未充分测试

**需要做的**:

- [ ] ASR (语音转文字) 端到端测试
  - [ ] 测试智谱 GLM ASR
  - [ ] 测试备用 API 切换
  - [ ] 验证 60 秒限制
- [ ] TTS (文字转语音) 端到端测试

  - [ ] 测试语音合成
  - [ ] 测试音频播放
  - [ ] 验证 mode=voice 时的完整流程

- [ ] 语音对话完整流程
  - [ ] 录音 → ASR → Agent 处理 → TTS → 播放
  - [ ] 测试多轮语音对话
  - [ ] 测试语音+文本混合对话

**预计时间**: 2 小时  
**优先级**: P1 (重要)

---

#### 2. 热门问题缓存优化 ⏳

**当前状态**: 每次从 JSON 文件读取

**需要做的**:

- [ ] 添加内存缓存

  ```typescript
  // server/agents/agent-b.ts
  private hotQuestionsCache: Map<string, HotQuestion[]> = new Map()
  private cacheExpiry: number = 5 * 60 * 1000 // 5分钟

  async loadHotQuestions(merchantId: string) {
    const cached = this.hotQuestionsCache.get(merchantId)
    if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
      return cached.data
    }
    // 从文件加载...
  }
  ```

- [ ] 添加缓存刷新机制
- [ ] 添加手动刷新 API

**预计时间**: 30 分钟  
**优先级**: P1 (性能优化)

---

#### 3. 配置管理完善 ⏳

**当前状态**: ConfigGeneratorPage 基本完成，但缺少部分功能

**需要做的**:

- [ ] API 配置的"其他"选项展开功能

  ```typescript
  // 支持自定义API配置
  - 自定义API地址
  - 自定义API Key
  - 自定义参数
  ```

- [ ] 数据源配置

  - [ ] 本地文件 / MongoDB 切换
  - [ ] MongoDB 连接配置界面

- [ ] 保存配置功能
  - [ ] PUT /api/merchant/:id/config
  - [ ] 配置验证
  - [ ] 配置生效

**预计时间**: 2 小时  
**优先级**: P1 (后台功能)

---

#### 4. 监控面板增强 ⏳

**当前状态**: 基本功能完成，可以添加更多指标

**需要做的**:

- [ ] 显示数据库连接状态

  ```typescript
  // MonitorPage.tsx
  <Card>
    <CardHeader>数据库状态</CardHeader>
    <CardContent>
      <div>Redis: {redisConnected ? "✅ 已连接" : "❌ 断开"}</div>
      <div>MongoDB: {mongoConnected ? "✅ 已连接" : "❌ 断开"}</div>
    </CardContent>
  </Card>
  ```

- [ ] 添加性能图表

  - [ ] 响应时间趋势图
  - [ ] 缓存命中率趋势图
  - [ ] 对话量趋势图

- [ ] 添加导出功能
  - [ ] 导出日志为 CSV
  - [ ] 导出统计报表

**预计时间**: 2 小时  
**优先级**: P1 (监控增强)

---

### P2 - 优化项目 (可选)

#### 5. 知识库 AI 整理功能 ⏳

**当前状态**: 界面已有，后端 API 未实现

**需要做的**:

- [ ] 实现 POST /api/merchant/:id/knowledge/ai-organize

  ```typescript
  // server/routes/knowledge.ts
  server.post("/api/merchant/:id/knowledge/ai-organize", async (req, reply) => {
    const { rawText } = req.body;

    // 调用AI整理
    const structured = await aiHelper.structureKnowledge(rawText);

    return { success: true, data: structured };
  });
  ```

- [ ] 创建 server/lib/knowledge-ai-helper.ts

  ```typescript
  export async function structureKnowledge(rawText: string) {
    const prompt = `
      请将以下文字整理成结构化的知识库条目：
      "${rawText}"
      
      返回JSON格式：
      {
        "title": "标题",
        "content": "内容",
        "keywords": ["关键词1", "关键词2"],
        "category": "分类"
      }
    `;

    const result = await callAI(prompt);
    return JSON.parse(result);
  }
  ```

- [ ] 前端集成
  - [ ] 粘贴文字
  - [ ] 调用 AI 整理
  - [ ] 预览结果
  - [ ] 确认保存

**预计时间**: 3 小时  
**优先级**: P2 (增强功能)

---

#### 6. 批量导入导出 ⏳

**当前状态**: 未实现

**需要做的**:

- [ ] 知识库批量导入

  - [ ] 支持 JSON 格式
  - [ ] 支持 Excel 格式
  - [ ] 数据验证

- [ ] 知识库批量导出

  - [ ] 导出为 JSON
  - [ ] 导出为 Excel

- [ ] 热门问题批量操作
  - [ ] 批量导入
  - [ ] 批量导出

**预计时间**: 2 小时  
**优先级**: P2 (便利功能)

---

#### 7. 用户认证增强 ⏳

**当前状态**: 基本 localStorage 认证

**需要做的**:

- [ ] JWT Token 认证
- [ ] 多用户管理
- [ ] 权限控制
- [ ] 登录日志

**预计时间**: 3 小时  
**优先级**: P2 (安全增强)

---

#### 8. 性能优化 ⏳

**需要做的**:

- [ ] Context Pool 查询优化

  - [ ] 添加索引
  - [ ] 查询缓存

- [ ] 知识库检索优化

  - [ ] 全文搜索索引
  - [ ] 相关度排序优化

- [ ] 并发处理优化
  - [ ] 请求队列机制
  - [ ] 限流保护

**预计时间**: 2 小时  
**优先级**: P2 (性能)

---

### P3 - 未来规划 (长期)

#### 9. 多商户管理 🔮

- [ ] 商户注册流程
- [ ] 商户独立配置
- [ ] 商户数据隔离
- [ ] 商户计费系统

**预计时间**: 1 周  
**优先级**: P3 (未来)

---

#### 10. 高级分析 🔮

- [ ] 用户行为分析
- [ ] 问题热度分析
- [ ] 缓存效果分析
- [ ] 成本分析报表

**预计时间**: 1 周  
**优先级**: P3 (未来)

---

## 📊 工作优先级建议

### 本周计划 (推荐)

**Day 1-2**:

1. ✅ 语音功能完整测试 (2h)
2. ✅ 热门问题缓存优化 (30min)
3. ✅ 配置管理完善 (2h)

**Day 3-4**: 4. ✅ 监控面板增强 (2h) 5. ✅ 知识库 AI 整理 (3h)

**Day 5**: 6. ✅ 批量导入导出 (2h) 7. ✅ 性能优化 (2h)

**总计**: 约 13.5 小时

---

### 下周计划 (可选)

- 用户认证增强
- 文档完善
- 部署优化
- 压力测试

---

## 🎯 里程碑

### 里程碑 1: MVP 完成 ✅

**时间**: 2026-01-16  
**标志**: 核心功能完成，可以使用

### 里程碑 2: 功能完善 ⏳

**时间**: 2026-01-20 (预计)  
**标志**: P1 功能全部完成

### 里程碑 3: 生产就绪 ⏳

**时间**: 2026-01-25 (预计)  
**标志**: 性能优化，文档完善

---

## 📝 已知问题

### 需要修复

1. **文档过时** (P1)

   - [ ] 归档 `系统架构修正版新！.md`
   - [ ] 归档 `项目诊断XRay.md`
   - [ ] 更新文档引用

2. **代码注释** (P2)
   - [ ] 补充部分文件注释
   - [ ] 添加使用示例

### 需要验证

1. **语音功能** (P1)

   - [ ] 端到端测试
   - [ ] 性能测试

2. **并发能力** (P2)
   - [ ] 50 人并发测试
   - [ ] 压力测试

---

## 🔍 技术债务

### 当前技术债务

1. **ASR 在前端调用** (P2)

   - 当前: 前端直接调用智谱 ASR
   - 理想: 通过/api/asr 代理
   - 影响: 安全性

2. **热门问题文件读取** (P1)

   - 当前: 每次从文件读取
   - 理想: 内存缓存 + 定时刷新
   - 影响: 性能

3. **配置保存未实现** (P1)
   - 当前: 只能查看配置
   - 理想: 可以修改保存
   - 影响: 功能完整性

---

## 📈 性能目标

### 当前性能

```
缓存命中率: 78%
响应时间: <300ms
Context Pool: <10ms
构建: 成功
Lint: 0错误
```

### 目标性能

```
缓存命中率: >80%
响应时间: <200ms
并发支持: 50人
语音延迟: <2s
```

---

## 🎉 总结

### 当前状态

**核心功能**: ✅ 100%完成  
**后台管理**: ✅ 90%完成  
**代码质量**: ✅ 优秀  
**文档**: ✅ 完善

### 推荐行动

**本周重点**:

1. 语音功能测试 (最重要)
2. 热门问题缓存优化
3. 配置管理完善
4. 监控面板增强

**下周重点**:

1. 知识库 AI 整理
2. 批量导入导出
3. 性能优化
4. 文档完善

---

**更新时间**: 2026-01-16  
**维护者**: 开发团队
