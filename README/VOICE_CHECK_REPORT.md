# è¯­éŸ³åŠŸèƒ½æ£€æŸ¥æŠ¥å‘Š

**åˆ›å»ºæ—¥æœŸ**: 2026-01-19  
**æœ€åæ›´æ–°**: 2026-01-20  
**ç‰ˆæœ¬**: 4.0

---

## 1. ä¸šåŠ¡æµç¨‹æ£€æŸ¥

### 1.1 è¯­éŸ³å½•éŸ³æµç¨‹ âœ…

```
ç”¨æˆ·ç‚¹å‡»ğŸ¤æŒ‰é’®
  â†“
æµè§ˆå™¨ getUserMedia è·å–éº¦å…‹é£æƒé™
  â†“
MediaRecorder å¼€å§‹å½•éŸ³ (webm;codecs=opusæ ¼å¼)
  â†“
ç”¨æˆ·ç‚¹å‡»â¹æŒ‰é’®åœæ­¢
  â†“
å‰ç«¯ convertToWav() è½¬æ¢ä¸º WAV æ ¼å¼
  - PCM 16-bit
  - å•å£°é“
  - ä¿æŒåŸå§‹é‡‡æ ·ç‡ (é€šå¸¸48kHz)
  â†“
FormData å‘é€åˆ° /api/process-input
```

### 1.2 ASRè¯†åˆ«æµç¨‹ âœ…

```
æœåŠ¡ç«¯æ¥æ”¶ FormData
  â†“
è§£æ audio å­—æ®µè·å– Buffer
  â†“
Agent A speechToText()
  â†“
ä¼˜å…ˆ: é˜¿é‡Œäº‘ DashScope (paraformer-v2)
å¤‡é€‰: æ™ºè°± GLM (glm-asr-2512)
  â†“
è¿”å›è¯†åˆ«æ–‡æœ¬
```

### 1.3 TTSåˆæˆæµç¨‹ âœ…

```
æ”¶åˆ°AIå›å¤ + enableTTS=true
  â†“
è°ƒç”¨ /api/tts { text, voice }
  â†“
ä¼˜å…ˆ: é˜¿é‡Œäº‘ CosyVoice-v2 (mp3)
å¤‡é€‰: æ™ºè°± GLM-TTS (wav)
  â†“
è¿”å› audioBase64
  â†“
å‰ç«¯ playBase64Audio() æ’­æ”¾
```

---

## 2. API é…ç½®æ£€æŸ¥

### 2.1 é˜¿é‡Œäº‘ DashScope ASR

| å‚æ•°   | å€¼                                        | çŠ¶æ€ |
| ------ | ----------------------------------------- | ---- |
| ç«¯ç‚¹   | `compatible-mode/v1/audio/transcriptions` | âœ…   |
| æ¨¡å‹   | `paraformer-v2`                           | âœ…   |
| æ ¼å¼   | `data:audio/wav;base64,{base64}`          | âœ…   |
| é‡‡æ ·ç‡ | ä»»æ„ (paraformer-v2æ”¯æŒ)                  | âœ…   |

### 2.2 é˜¿é‡Œäº‘ CosyVoice TTS

| å‚æ•°     | å€¼                                | çŠ¶æ€        |
| -------- | --------------------------------- | ----------- |
| ç«¯ç‚¹     | `compatible-mode/v1/audio/speech` | âœ…          |
| æ¨¡å‹     | `cosyvoice-v2`                    | âœ… (å·²ä¿®å¤) |
| å¥³å£°     | `longxiaoxia_v2`                  | âœ… (å·²ä¿®å¤) |
| ç”·å£°     | `longxiaochun_v2`                 | âœ… (å·²ä¿®å¤) |
| è¾“å‡ºæ ¼å¼ | `mp3`                             | âœ…          |

### 2.3 æ™ºè°± GLM ASR (å¤‡é€‰)

| å‚æ•° | å€¼                                                  | çŠ¶æ€ |
| ---- | --------------------------------------------------- | ---- |
| ç«¯ç‚¹ | `open.bigmodel.cn/api/paas/v4/audio/transcriptions` | âœ…   |
| æ¨¡å‹ | `glm-asr-2512`                                      | âœ…   |
| æ ¼å¼ | FormData + wavæ–‡ä»¶                                  | âœ…   |

### 2.4 æ™ºè°± GLM TTS (å¤‡é€‰)

| å‚æ•°     | å€¼                                          | çŠ¶æ€ |
| -------- | ------------------------------------------- | ---- |
| ç«¯ç‚¹     | `open.bigmodel.cn/api/paas/v4/audio/speech` | âœ…   |
| æ¨¡å‹     | `glm-tts`                                   | âœ…   |
| è¾“å‡ºæ ¼å¼ | `wav`                                       | âœ…   |

---

## 3. å‰ç«¯UIæ£€æŸ¥

### 3.1 ç¯å¢ƒæ£€æµ‹ âœ…

- æµè§ˆå™¨ç±»å‹æ£€æµ‹ (wechat/chrome/firefox/safari/edge)
- éº¦å…‹é£æƒé™æ£€æµ‹ (granted/denied/prompt)
- æ’­æ”¾èƒ½åŠ›æ£€æµ‹
- ç§»åŠ¨ç«¯æ£€æµ‹

### 3.2 ç”¨æˆ·é€‰æ‹© âœ…

- ğŸ¤ è¯­éŸ³æ¨¡å¼ / âŒ¨ï¸ æ–‡å­—æ¨¡å¼ åˆ‡æ¢æŒ‰é’®
- ğŸ”Š è¯­éŸ³æ’­æŠ¥å¼€ / ğŸ”‡ è¯­éŸ³æ’­æŠ¥å…³ åˆ‡æ¢æŒ‰é’®
- ä¸æ”¯æŒå½•éŸ³æ—¶æ˜¾ç¤ºè­¦å‘Š

### 3.3 é»˜è®¤å€¼è®¾ç½®

| è®¾ç½®          | é»˜è®¤å€¼  | æ¡ä»¶                     |
| ------------- | ------- | ------------------------ |
| userInputMode | `text`  | URLæ— modeå‚æ•°æ—¶          |
| userInputMode | `voice` | URL mode=voiceä¸”æ”¯æŒå½•éŸ³ |
| enableTTS     | `false` | é»˜è®¤                     |
| enableTTS     | `true`  | mode=voiceæ—¶è‡ªåŠ¨å¼€å¯     |

---

## 4. å·²ä¿®å¤é—®é¢˜

### 4.1 TTSæ¨¡å‹åç§°é”™è¯¯ âœ…

- åŸ: `cosyvoice-v1`
- ä¿®: `cosyvoice-v2`

### 4.2 éŸ³è‰²åç§°é”™è¯¯ âœ…

- åŸ: `longxiaoxia`
- ä¿®: `longxiaoxia_v2`

---

## 5. è¾“å…¥ç»Ÿè®¡

### 5.1 API

- POST `/api/stats/input` - è®°å½•è¾“å…¥
- GET `/api/stats/input/:merchantId` - è·å–ç»Ÿè®¡

### 5.2 ç»Ÿè®¡å­—æ®µ

```json
{
  "text": 10, // æ–‡å­—è¾“å…¥æ¬¡æ•°
  "voice": 5, // è¯­éŸ³è¾“å…¥æ¬¡æ•°
  "lastUpdated": "2026-01-19T03:40:00Z"
}
```

---

## 6. æµ‹è¯•å»ºè®®

### 6.1 è¯­éŸ³æ¨¡å¼æµ‹è¯•

```
http://localhost:5173/chat?merchant=dongli&mode=voice
```

### 6.2 æ–‡å­—æ¨¡å¼æµ‹è¯•

```
http://localhost:5173/chat?merchant=dongli
```

### 6.3 éªŒè¯ç‚¹

1. å½•éŸ³æŒ‰é’®å“åº”
2. å½•éŸ³æ—¶é•¿æ˜¾ç¤º
3. è½¬æ¢è¿›åº¦æ—¥å¿—
4. ASRè¯†åˆ«ç»“æœ
5. TTSæ’­æ”¾æ•ˆæœ
6. ç»Ÿè®¡æ•°æ®æ›´æ–°
