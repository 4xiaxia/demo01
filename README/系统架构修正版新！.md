# ğŸ¯ ç³»ç»Ÿæ¶æ„ä¿®æ­£ç‰ˆ (åŸºäºç”¨æˆ·æ‰¹æ”¹)

> **é‡è¦**: è¿™æ˜¯åŸºäºç”¨æˆ·æ·±åº¦æ‰¹æ”¹åçš„æ­£ç¡®ç†è§£
> **æ ¸å¿ƒæ€æƒ³**: ä¸´æ—¶å·¥å°åˆ†é˜Ÿæ¥å•æ¨¡å¼ + 24å°æ—¶é»‘æ¿ç¼“å­˜

---

## ğŸ—ï¸ æ ¸å¿ƒæ¦‚å¿µé‡æ–°ç†è§£

### "ä¸´

æ—¶å·¥å°åˆ†é˜Ÿ"æ¯”å–»

```
ç”¨æˆ·è¯·æ±‚ = è®¢å•ç”µè¯
å•†å®¶ = å·¥ä½œé—´/æˆ¿é—´å‘
ABCDå››äººç»„ = ä¸´æ—¶å·¥å°åˆ†é˜Ÿ
é…ç½®(config.json) = å·¥ä½œæœè£…/å·¥å…·
é»‘æ¿(context-pool) = 24å°æ—¶å…±äº«è®°å½•æ¿
ç›‘å·¥æ‘„åƒæœº = Agent Dæ—¥å¿—ç³»ç»Ÿ
```

---

## ğŸ”„ æ­£ç¡®çš„å·¥ä½œæµç¨‹

### é˜¶æ®µ1: æ¥å•å‡†å¤‡

```
ç”¨æˆ·ç‚¹å‡»é“¾æ¥: https://åŸŸå?merchantId=dongli&userId=uuid123&mode=voice&timestamp=xxx
  â†“
ç³»ç»Ÿè¯†åˆ«å‚æ•°:
  - merchantId: "dongli" (å»å“ªä¸ªå•†å®¶çš„æˆ¿é—´)
  - userId: "uuid123" (ç”¨æˆ·æ ‡è¯†)
  - mode: "voice" | "text" (å¯¹è¯æ¨¡å¼)
  - timestamp: å½“å‰æ—¶é—´
  â†“
ABCDå››äººç»„è¿›å…¥"dongliæˆ¿é—´":
  âœ… åŠ è½½å•†æˆ·é…ç½® (ç©¿å·¥ä½œæœ)
  âœ… è¯»å–é»‘æ¿å†å² (24å°æ—¶å†…è¯¥uuidçš„å¯¹è¯)
  âœ… å‡†å¤‡å¥½å„è‡ªå·¥å…·
  âœ… Då¯åŠ¨å½•åƒç›‘æ§
```

**å…³é”®ç‚¹â‘ **: 
- å‰ç«¯UIæ ¹æ®modeæ˜¾ç¤ºï¼š
  - `mode='voice'` â†’ åªæ˜¾ç¤ºè¯­éŸ³æŒ‰é’®
  - `mode='text'` â†’ åªæ˜¾ç¤ºè¾“å…¥æ¡†
- **ä¸éœ€è¦AIåˆ¤æ–­æ¨¡å¼**ï¼Œç”¨æˆ·å·²ç»é€‰æ‹©äº†ï¼

---

### é˜¶æ®µ2: Agentå·¥ä½œæµç¨‹

#### Dç›‘æ§å¯åŠ¨ (æœ€å…ˆ)

```typescript
// ç”¨æˆ·ä¸€è¿›æ¥ï¼Œç³»ç»Ÿå°±é€šçŸ¥D
Dæ”¶åˆ°: {
  äº‹ä»¶: "ç”¨æˆ·è¿›å…¥",
  merchantId: "dongli",
  userId: "uuid123",
  mode: "voice",
  timestamp: xxx
}

Dè®°å½•: "ç”¨æˆ·uuid123è¿›å…¥dongliæˆ¿é—´ï¼Œä½¿ç”¨è¯­éŸ³æ¨¡å¼"
DçŠ¶æ€: å¾…å‘½ä¸­ï¼Œç­‰å¾…ABCDçš„å·¥ä½œæŠ¥å‘Š
```

**å…³é”®ç‚¹â‘¡**: 
- **Dä¸ä¾èµ–A**ï¼ç³»ç»Ÿç›´æ¥é€šçŸ¥D
- å¦‚æœAæŒ‚äº†ï¼ŒDç«‹åˆ»çŸ¥é“ï¼ˆå› ä¸ºæ²¡æ”¶åˆ°Açš„okï¼‰

---

#### Açš„å·¥ä½œ (æ„å›¾è¯†åˆ« + åˆ†ç±»)

```typescript
// mode='voice'æ—¶
1. æ¥æ”¶è¯­éŸ³Blob
2. è°ƒç”¨å•†æˆ·é…ç½®çš„ASRæ¨¡å‹ (è¯»å–config.apiConfig.asr)
3. å¾—åˆ°æ–‡æœ¬: "ä¸œé‡Œæ‘é—¨ç¥¨å¤šå°‘é’±"

// æ„å›¾åˆ†ç±» (æ–°å¢"åºŸè¯"åˆ†ç±»)
4. åˆ†ç±»é—®é¢˜:
   - ä»·æ ¼ç›¸å…³? â†’ PRICE_QUERY
   - ä½ç½®ç›¸å…³? â†’ LOCATION_QUERY
   - æ—¶é—´ç›¸å…³? â†’ TIME_QUERY
   - **åºŸè¯/é—²èŠ?** â†’ CHITCHAT âœ… (æ–°å¢)
   
5. ç²¾ç®€é—®é¢˜: "é—¨ç¥¨ä»·æ ¼"

6. ä¸¢å…¥é»‘æ¿æ± :
   contextPool.addTurn(merchantId, userId, sessionId, {
     role: 'user',
     content: 'ä¸œé‡Œæ‘é—¨ç¥¨å¤šå°‘é’±',
     refined: 'é—¨ç¥¨ä»·æ ¼',
     intent: 'PRICE_QUERY',
     inputType: 'voice',
     timestamp: Date.now()
   })

7. é€šçŸ¥@D: "A-okï¼Œé—®é¢˜å·²å…¥æ± "
8. é€šçŸ¥@B: "Bå“¥ï¼Œæ± å­é‡Œæœ‰æ´»äº†ï¼Œuuid123çš„é—®é¢˜"
```

**å…³é”®ç‚¹â‘¢**:
- **Açš„APIå¯ä»¥é…ç½®å¤šä¸ªå¤‡ç”¨** (è½®æ¢ä½¿ç”¨)
  - æ™ºè°±: 0.0002å…ƒ/ç§’
  - åƒé—®: 0.00008å…ƒ/ç§’
  - å•†å®¶æ ¹æ®ä¸šåŠ¡é‡é€‰æ‹©
- **è¯­éŸ³é™åˆ¶60ç§’å†…**

---

#### Bçš„å·¥ä½œ (å†³ç­–ä¸­å¿ƒ - 4ç§æƒ…å†µ)

```typescript
æ”¶åˆ°@Bé€šçŸ¥ â†’ å»æ± å­çœ‹uuid123çš„é—®é¢˜

// ===== æƒ…å†µ1: é»‘æ¿ä¸Šæœ‰ç°æˆç­”æ¡ˆ (æœ€å¿«) =====
if (24å°æ—¶é»‘æ¿å†…æœ‰ç›¸åŒé—®é¢˜çš„ç­”æ¡ˆ) {
  answer = ä»é»‘æ¿å–ç­”æ¡ˆ
  
  if (mode === 'voice') {
    // æ¶¦è‰²å›å¤ (è®©AIä¼˜åŒ–è¯­è¨€)
    answer = await æ¶¦è‰²(answer, systemPrompt)
    audioBase64 = await textToSpeech(answer)
  }
  
  // ä¸¢å›æ± å­
  contextPool.addTurn(..., { role: 'assistant', content: answer })
  
  // é€šçŸ¥Då’Œç”¨æˆ·
  emit('â†’D', 'B-ok')
  emit('Bâ†’USER', { response: answer, audioBase64 })
}

// ===== æƒ…å†µ2: é»‘æ¿æ²¡æœ‰ï¼Œé—®C =====
else if (intent !== 'CHITCHAT') {
  // ä¸šåŠ¡é—®é¢˜ï¼Œéœ€è¦æŸ¥çŸ¥è¯†åº“
  é—®é¢˜ä¸¢å…¥æ± 
  emit('Bâ†’C', { query, @Cçœ‹æ±  })
  emit('â†’D', 'é—®é¢˜å·²è½¬C')
  ç­‰å¾…C...
}

// ===== æƒ…å†µ3: ä»·æ ¼é—®é¢˜ (è®¤çœŸå›ç­”) =====
else if (intent === 'PRICE_QUERY') {
  // ä¸“é—¨å¤„ç†ä»·æ ¼ç›¸å…³ï¼Œä¿è¯å‡†ç¡®
  ç»“æœ = await C.search(query)
  if (ç»“æœå‡†ç¡®) {
    è®¤çœŸå›å¤ä»·æ ¼
  } else {
    AIå…œåº•ä½†æç¤º"å»ºè®®å’¨è¯¢å·¥ä½œäººå‘˜"
  }
}

// ===== æƒ…å†µ4: åºŸè¯/é—²èŠ (æ¸©æŸ”å¤„ç†) =====
else if (intent === 'CHITCHAT') {
  // çœ‹ä¸Šä¸‹æ–‡ï¼Œæ¸©æŸ”å›å¤
  context = contextPool.getRecentTurns(...)
  answer = await AIæ¸©æŸ”å›å¤(query, context)
  
  // ä¸¢å…¥æ± 
  contextPool.addTurn(..., { role: 'assistant', content: answer })
  
  // é€šçŸ¥D: éä¸šåŠ¡é—®é¢˜
  emit('â†’D', { type: 'CHITCHAT', query })
  emit('Bâ†’USER', { response: answer })
}
```

**å…³é”®ç‚¹â‘£**:
- **Bæ ¹æ®intentèµ°ä¸åŒæµç¨‹**
- **Bä¸¢å›å¤åˆ°æ± å­ï¼ŒCä¸ä¸¢** (Cåªçœ‹æ± ï¼ŒBè´Ÿè´£å®Œç»“)
- **è¯­éŸ³æ¨¡å¼æ‰è°ƒç”¨TTS**

---

#### Cçš„å·¥ä½œ (çŸ¥è¯†åº“æ£€ç´¢)

```typescript
æ”¶åˆ°@C â†’ å»æ± å­çœ‹é—®é¢˜

1. è¯»å–å•†æˆ·é…ç½®: dataSource = 'local' | 'remote'

2. æœç´¢:
   if (dataSource === 'local') {
     results = smartSearch(items, query)
   } else {
     results = await MongoDB.search(query)
   }

3. å¦‚æœå‘½ä¸­å¤šä¸ª:
   // ç»“åˆä¸Šä¸‹æ–‡é€‰æœ€ä½³ç­”æ¡ˆ
   context = contextPool.getRecentTurns(...)
   bestResult = é€‰æ‹©æœ€ç›¸å…³çš„(results, context)
   
   emit('â†’D', 'å‘½ä¸­å¤šä¸ªï¼Œå·²ç»“åˆä¸Šä¸‹æ–‡é€‰æ‹©')

4. è¿”å›ç»™B:
   emit('Câ†’B', { 
     found: true, 
     content: bestResult.content 
   })
   
5. é€šçŸ¥D:
   emit('â†’D', 'C-ok')
```

**å…³é”®ç‚¹â‘¤**:
- **Cåªçœ‹æ± ï¼Œä¸å†™æ± **
- **Cä¸“æ³¨çŸ¥è¯†æ£€ç´¢**
- **å‘½ä¸­å¤šæ¡æ—¶ç»“åˆä¸Šä¸‹æ–‡**

---

#### Dçš„å·¥ä½œ (ç›‘æ§å½•åƒ)

```typescript
// å…¨ç¨‹ç›‘æ§
bus.on('*', (msg) => {
  è®°å½•åˆ°æ—¥å¿—é˜Ÿåˆ—:
    - userId
    - merchantId
    - æ¶ˆæ¯ç±»å‹
    - æ—¶é—´æˆ³
    - å†…å®¹
})

// ä¸“é—¨å¤„ç†é€šçŸ¥
bus.on('â†’D', (msg) => {
  switch (msg.type) {
    case 'A-ok':
      å¥åº·æ£€æŸ¥.A = true
      break
    case 'CHITCHAT':
      åˆ†ç±»ç»Ÿè®¡.é—²èŠ += 1
      break
    case 'å‘½ä¸­å¤šä¸ª':
      è®°å½•å¾…ä¼˜åŒ–é¡¹
      break
  }
})

// æ•…éšœæ£€æµ‹
if (è¶…è¿‡5ç§’æ²¡æ”¶åˆ°Açš„ok) {
  å‘Šè­¦: "Aå¯èƒ½æŒ‚äº†"
  é€šçŸ¥ç³»ç»Ÿç®¡ç†å‘˜
}
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡ (ç”¨æˆ·è¦æ±‚)

### ç”¨æˆ·æ˜ç»†è¡¨ (logé˜Ÿåˆ—)

```sql
CREATE TABLE user_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  merchant_id VARCHAR(50) NOT NULL,
  user_id VARCHAR(100) NOT NULL,
  session_id VARCHAR(100) NOT NULL,
  
  -- å¯¹è¯å†…å®¹
  role ENUM('user', 'assistant', 'system'),
  content TEXT,
  refined_question VARCHAR(500),
  intent VARCHAR(50),
  
  -- å…ƒæ•°æ®
  input_type ENUM('voice', 'text'),
  source VARCHAR(50),  -- 'hot_cache', 'database', 'ai_qwen_tools', 'ai_fallback'
  cost_ms INT,
  
  -- æ—¶é—´
  created_at DATETIME NOT NULL,
  
  INDEX idx_merchant_user (merchant_id, user_id),
  INDEX idx_created_at (created_at)
);

-- 24å°æ—¶è‡ªåŠ¨æ¸…ç†
DELETE FROM user_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 24 HOUR);
```

---

## ğŸ›ï¸ ä¿®æ­£åçš„é…ç½®è¦æ±‚

### .env å¢åŠ å¤‡ç”¨æ¨¡å‹

```bash
# ASRå¤‡ç”¨ (è½®æ¢)
VITE_ASR_PRIMARY=zhipu
VITE_ASR_BACKUP=dashscope
VITE_ZHIPU_API_KEY=xxx
VITE_DASHSCOPE_API_KEY=xxx

# LLMå¤‡ç”¨
VITE_LLM_PRIMARY=siliconflow
VITE_LLM_BACKUP=zhipu
VITE_SILICONFLOW_API_KEY=xxx  # åƒé—® qwen3-0.8
VITE_ZHIPU_LLM_KEY=xxx         # æ™ºè°± glm-4-flash

# TTSå¤‡ç”¨
VITE_TTS_PRIMARY=zhipu
VITE_TTS_BACKUP=dashscope
```

### config.json ä¿®æ­£

```json
{
  "merchantId": "dongli",
  "name": "ä¸œé‡Œæ‘æ™¯åŒº",
  
  "prompts": {
    "system": "ä½ æ˜¯ä¸œé‡Œæ‘çš„æ™ºèƒ½å¯¼æ¸¸...",
    "welcome": "æ‚¨å¥½ï¼æ¬¢è¿æ¥åˆ°ä¸œé‡Œæ‘ï¼",
    "chitchat": "æˆ‘æ˜¯å¯¼æ¸¸åŠ©æ‰‹ï¼Œä¸“é—¨å›ç­”æ™¯åŒºç›¸å…³é—®é¢˜å“¦~"  // æ–°å¢
  },
  
  "apiConfig": {
    "asr": {
      "primary": "zhipu",
      "backup": ["dashscope"],
      "maxDuration": 60  // è¯­éŸ³æœ€é•¿60ç§’
    },
    "tts": {
      "primary": "zhipu",
      "backup": ["dashscope"]
    },
    "llm": {
      "primary": "siliconflow",
      "model": "Qwen/Qwen3-0.5B",  // qwen3-0.8
      "backup": {
        "provider": "zhipu",
        "model": "glm-4-flash"
      }
    }
  },
  
  "dataSource": "local",  // æˆ– "remote"
  
  "cache": {
    "ttl": 86400  // 24å°æ—¶ (ç§’)
  }
}
```

---

## ğŸ”§ å¿…é¡»ä¿®å¤çš„é—®é¢˜

### 1. å‰ç«¯UIæ¨¡å¼åˆ‡æ¢

```typescript
// ChatPage.tsx
const [mode, setMode] = useState<'voice' | 'text'>('text')

// ä»URLè·å–æ¨¡å¼
useEffect(() => {
  const params = new URLSearchParams(window.location.search)
  const urlMode = params.get('mode') as 'voice' | 'text'
  if (urlMode) {
    setMode(urlMode)
  }
}, [])

return (
  <div>
    {mode === 'voice' ? (
      <VoiceButton />  // åªæ˜¾ç¤ºè¯­éŸ³æŒ‰é’®
    ) : (
      <TextInput />    // åªæ˜¾ç¤ºè¾“å…¥æ¡†
    )}
  </div>
)
```

### 2. ä¸Šä¸‹æ–‡æ± TTLæ”¹ä¸º24å°æ—¶

```typescript
// context-pool.ts
class ContextPool {
  private TTL = 24 * 60 * 60 * 1000; // 24å°æ—¶ âœ…
  
  // ... å…¶ä»–ä»£ç 
}
```

### 3. Aå¢åŠ CHITCHATåˆ†ç±»

```typescript
// agent-a.ts
private classifyIntent(text: string): IntentCategory {
  // é—²èŠæ£€æµ‹
  const chitchatPatterns = [
    /^(ä½ å¥½|hi|hello|å—¨)/i,
    /^(åœ¨å—|åœ¨ä¸åœ¨)/i,
    /ä»Šå¤©.*å¤©æ°”/,
    /èŠå¤©/
  ]
  
  if (chitchatPatterns.some(p => p.test(text))) {
    return 'CHITCHAT' as IntentCategory
  }
  
  // ... åŸæœ‰åˆ†ç±»é€»è¾‘
}
```

### 4. Dç‹¬ç«‹åˆå§‹åŒ–

```typescript
// ç³»ç»Ÿå¯åŠ¨æ—¶ç«‹å³é€šçŸ¥D
// main.tsx æˆ– App.tsx
useEffect(() => {
  const params = new URLSearchParams(window.location.search)
  
  agentD.logUserEnter({
    merchantId: params.get('merchantId') || 'dongli',
    userId: params.get('userId') || generateUserId(),
    mode: params.get('mode') as 'voice' | 'text' || 'text',
    timestamp: Date.now()
  })
}, [])
```

---

## âœ… ä¿®æ­£æ€»ç»“

| åŸç†è§£ | ä¿®æ­£å |
|--------|--------|
| ä¸Šä¸‹æ–‡TTL 30åˆ†é’Ÿ | **24å°æ—¶** âœ… |
| å‰ç«¯AIåˆ¤æ–­æ¨¡å¼ | **URLå‚æ•°æŒ‡å®šï¼Œå‰ç«¯æ¡ä»¶æ¸²æŸ“** âœ… |
| åªæœ‰ABCDé€šä¿¡ | **ç³»ç»Ÿâ†’Dç‹¬ç«‹é€šä¿¡** âœ… |
| 3ç§æ„å›¾åˆ†ç±» | **å¢åŠ CHITCHATé—²èŠåˆ†ç±»** âœ… |
| Cå†™å…¥ç¼“å­˜ | **Cåªè¯»ï¼ŒBè´Ÿè´£å†™å’ŒæŸ¥è¯¢** âœ… |
| å•ä¸€APIé…ç½® | **ä¸»å¤‡å¤šAPIè½®æ¢** âœ… |
| å†…å­˜log | **æ•°æ®åº“ç”¨æˆ·æ˜ç»†è¡¨** âœ… |

---

**çŠ¶æ€**: âš ï¸ éœ€è¦æŒ‰æ­¤ä¿®æ­£ä»£ç 
**ä¼˜å…ˆçº§**: P0 - ç«‹å³ä¿®å¤





sequenceDiagram
    participant U as User(ç”¨æˆ·)
    participant FE as Frontend(å‰ç«¯H5)
    participant D as AgentD(ç›‘æ§æ—¥å¿—)
    participant CS as ConfigService(é…ç½®æœåŠ¡)
    participant CP as ContextPool(24hç¼“å­˜æ± )
    participant A as AgentA(ASR/æ„å›¾åˆ†ç±»)
    participant B as AgentB(å†³ç­–ä¸­å¿ƒ)
    participant C as AgentC(çŸ¥è¯†åº“æ£€ç´¢)
    participant KB as KnowledgeBase(çŸ¥è¯†åº“)
    participant DB as Database(ç”¨æˆ·æ—¥å¿—åº“)
    participant VS as VoiceService(TTS/ASR)

    %% é˜¶æ®µ1ï¼šåˆå§‹åŒ–ï¼ˆURLå‚æ•°é©±åŠ¨ï¼‰
    U->>FE: è®¿é—®URL<br/>?merchantId=dongli&userId=uuid&mode=voice&timestamp=xxx
    FE->>FE: è§£æURLå‚æ•°<br/>éªŒè¯merchantId/userId/modeå¿…ä¼ 
    FE->>D: ç³»ç»Ÿå¹¿æ’­ï¼šç”¨æˆ·è¿›å…¥<br/>(merchantId+userId+mode)
    D->>DB: è®°å½•ï¼šç”¨æˆ·è¿›å…¥äº‹ä»¶ï¼ˆåˆå§‹åŒ–æ—¥å¿—ï¼‰
    FE->>CS: åŠ è½½å•†æˆ·é…ç½®<br/>(apikey/prompt/æ•°æ®æº/TTL=24h)
    CS->>CP: è¯»å–è¯¥userId24hå†…ç¼“å­˜è®°å½•
    D->>D: ç›‘æ§çŠ¶æ€ï¼šå¾…Agentå“åº”

    %% é˜¶æ®µ2ï¼šç”¨æˆ·è¾“å…¥ï¼ˆè¯­éŸ³/æ–‡æœ¬ï¼‰
    U->>FE: è¯­éŸ³è¾“å…¥ï¼ˆâ‰¤60ç§’ï¼‰/æ–‡æœ¬è¾“å…¥
    FE->>A: è½¬å‘è¾“å…¥å†…å®¹+ä¸Šä¸‹æ–‡å‚æ•°

    %% é˜¶æ®µ3ï¼šAgentAå¤„ç†ï¼ˆASR+æ„å›¾åˆ†ç±»ï¼‰
    A->>VS: è°ƒç”¨ä¸»å¤‡ASRï¼ˆæ™ºè°±/åƒé—®ï¼‰<br/>è¯­éŸ³è½¬æ–‡æœ¬
    VS-->>A: è¿”å›è½¬å†™æ–‡æœ¬
    A->>A: æ„å›¾åˆ†ç±»ï¼ˆPRICE/CHITCHATç­‰ï¼‰<br/>ç²¾ç®€é—®é¢˜
    A->>CP: å†™å…¥ç”¨æˆ·é—®é¢˜åˆ°ç¼“å­˜æ± 
    A->>D: é€šçŸ¥ï¼šA-okï¼ˆæ„å›¾+ç²¾ç®€é—®é¢˜ï¼‰
    D->>DB: è®°å½•ï¼šAå¤„ç†å®Œæˆ
    A->>B: è§¦å‘ï¼šBå¤„ç†è¯¥ç”¨æˆ·é—®é¢˜

    %% é˜¶æ®µ4ï¼šAgentBå†³ç­–ï¼ˆç¼“å­˜ä¼˜å…ˆï¼‰
    B->>CP: æŸ¥è¯¢è¯¥userId24hå†…ç¼“å­˜
    alt ç¼“å­˜å‘½ä¸­ï¼ˆæƒ…å†µ1ï¼‰
        CP-->>B: è¿”å›ç¼“å­˜ä¸­çš„ç­”æ¡ˆ
        B->>VS: mode=voiceâ†’è°ƒç”¨TTSæ¶¦è‰²
        VS-->>B: è¿”å›è¯­éŸ³Base64
        B->>CP: å†™å…¥å›å¤å†…å®¹åˆ°ç¼“å­˜æ± 
        B->>FE: è¿”å›å›å¤ï¼ˆæ–‡æœ¬/è¯­éŸ³ï¼‰
        FE->>U: å±•ç¤ºå›å¤
        B->>D: é€šçŸ¥ï¼šB-okï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
        D->>DB: è®°å½•ï¼šç¼“å­˜å‘½ä¸­+å›å¤å†…å®¹
    else ç¼“å­˜æœªå‘½ä¸­+éCHITCHATï¼ˆæƒ…å†µ2ï¼‰
        B->>CP: å†™å…¥å¾…æ£€ç´¢é—®é¢˜
        B->>D: é€šçŸ¥ï¼šè½¬Cå¤„ç†
        D->>DB: è®°å½•ï¼šè½¬çŸ¥è¯†åº“æ£€ç´¢
        B->>C: è§¦å‘ï¼šCæ£€ç´¢çŸ¥è¯†åº“
        %% AgentCæ£€ç´¢æµç¨‹
        C->>CS: è¯»å–å•†æˆ·æ•°æ®æºé…ç½®ï¼ˆlocal/remoteï¼‰
        alt æœ¬åœ°æ•°æ®æº
            C->>KB: æœ¬åœ°æ™ºèƒ½æ£€ç´¢ï¼ˆå…³é”®è¯+æƒé‡ï¼‰
        else äº‘ç«¯æ•°æ®æº
            C->>KB: äº‘æ•°æ®åº“å…³é”®è¯æ£€ç´¢
        end
        KB-->>C: è¿”å›æ£€ç´¢ç»“æœï¼ˆå¤šæ¡/å•æ¡ï¼‰
        alt å‘½ä¸­å¤šæ¡ç»“æœ
            C->>CP: è¯»å–ä¸Šä¸‹æ–‡
            C->>C: ç»“åˆä¸Šä¸‹æ–‡é€‰æœ€ä½³ç­”æ¡ˆ
        end
        C->>B: è¿”å›æœ€ä½³ç­”æ¡ˆ
        C->>D: é€šçŸ¥ï¼šC-okï¼ˆæ£€ç´¢å®Œæˆï¼‰
        D->>DB: è®°å½•ï¼šæ£€ç´¢ç»“æœ+å‘½ä¸­æ•°
        %% Bå¤„ç†Cè¿”å›çš„ç­”æ¡ˆ
        B->>CP: å†™å…¥å›å¤å†…å®¹åˆ°ç¼“å­˜æ± 
        B->>FE: è¿”å›å›å¤ï¼ˆæ–‡æœ¬/è¯­éŸ³ï¼‰
        FE->>U: å±•ç¤ºå›å¤
        B->>D: é€šçŸ¥ï¼šB-okï¼ˆCæ£€ç´¢å®Œæˆï¼‰
        D->>DB: è®°å½•ï¼šå›å¤å†…å®¹
    else æ„å›¾=PRICE_QUERYï¼ˆæƒ…å†µ3ï¼‰
        B->>C: è§¦å‘ï¼šç²¾å‡†ä»·æ ¼æ£€ç´¢
        C->>KB: ä»·æ ¼ä¸“å±æ£€ç´¢
        KB-->>C: è¿”å›ç²¾å‡†ä»·æ ¼
        C->>B: ä»·æ ¼ç»“æœ
        B->>CP: å†™å…¥ä»·æ ¼å›å¤åˆ°ç¼“å­˜
        B->>FE: è¿”å›ä»·æ ¼å›å¤
        FE->>U: å±•ç¤ºå›å¤
        B->>D: é€šçŸ¥ï¼šB-okï¼ˆä»·æ ¼æŸ¥è¯¢ï¼‰
        D->>DB: è®°å½•ï¼šä»·æ ¼æŸ¥è¯¢+ç»“æœ
    else æ„å›¾=CHITCHATï¼ˆæƒ…å†µ4ï¼‰
        B->>CP: è¯»å–ä¸Šä¸‹æ–‡
        B->>B: AIç”Ÿæˆæ¸©æŸ”å›å¤ï¼ˆå¼•å¯¼ä¸šåŠ¡ï¼‰
        B->>CP: å†™å…¥é—²èŠå›å¤åˆ°ç¼“å­˜
        B->>FE: è¿”å›é—²èŠå›å¤
        FE->>U: å±•ç¤ºå›å¤
        B->>D: é€šçŸ¥ï¼šB-okï¼ˆéä¸šåŠ¡é—²èŠï¼‰
        D->>DB: è®°å½•ï¼šé—²èŠé—®é¢˜+å›å¤
    end

    %% é˜¶æ®µ5ï¼šæ—¥å¿—æ¸…ç†ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
    DB->>DB: å®šæ—¶æ¸…ç†ï¼š>24hçš„æ—¥å¿—æ•°æ®


    graph TB
    %% æ ·å¼å®šä¹‰ï¼ˆæŠ€æœ¯åˆ†å±‚è‰²æ ‡ï¼‰
    classDef client fill:#e1f5fe,stroke:#0277bd,stroke-width:2px,color:#000
    classDef gateway fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef agent fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef data fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef infra fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#000

    %% ç¬¬ä¸€å±‚ï¼šå®¢æˆ·ç«¯å±‚
    subgraph Client Layer [å®¢æˆ·ç«¯å±‚]
        U[ç”¨æˆ·]:::client
        FE[å‰ç«¯H5<br/>- URLå‚æ•°è§£æ<br/>- æ¨¡å¼æ¡ä»¶æ¸²æŸ“<br/>- è¯­éŸ³/æ–‡æœ¬äº¤äº’]:::client
    end

    %% ç¬¬äºŒå±‚ï¼šç½‘å…³/æ¥å…¥å±‚
    subgraph Gateway Layer [ç½‘å…³/æ¥å…¥å±‚]
        GW[API Gateway<br/>- å‚æ•°æ ¡éªŒ<br/>- è·¯ç”±åˆ†å‘<br/>- é™æµç†”æ–­]:::gateway
        DS[Dispatch Service<br/>- å•†æˆ·/ç”¨æˆ·ä¸Šä¸‹æ–‡åˆå§‹åŒ–<br/>- AgentDç‹¬ç«‹è§¦å‘]:::gateway
    end

    %% ç¬¬ä¸‰å±‚ï¼šAgentä¸šåŠ¡å±‚
    subgraph Agent Layer [Agentä¸šåŠ¡å±‚]
        A[AgentA<br/>- ASRä¸»å¤‡è½®æ¢<br/>- æ„å›¾åˆ†ç±»ï¼ˆå«CHITCHATï¼‰<br/>- é—®é¢˜ç²¾ç®€]:::agent
        B[AgentB<br/>- 24hç¼“å­˜ä¼˜å…ˆ<br/>- å››ç±»åœºæ™¯å†³ç­–<br/>- æœ€ç»ˆå›å¤å†™å…¥ç¼“å­˜]:::agent
        C[AgentC<br/>- å¤šæ•°æ®æºæ£€ç´¢<br/>- å¤šç»“æœä¸Šä¸‹æ–‡ä¼˜é€‰<br/>- åªè¯»ä¸å†™ç¼“å­˜]:::agent
        D[AgentD<br/>- å…¨æµç¨‹æ—¥å¿—è®°å½•<br/>- ç‹¬ç«‹ç›‘æ§å‘Šè­¦<br/>- è¶…æ—¶æ£€æµ‹ï¼ˆA/B/Cï¼‰]:::agent
    end

    %% ç¬¬å››å±‚ï¼šæ•°æ®å±‚
    subgraph Data Layer [æ•°æ®å±‚]
        CS[Config Service<br/>- å•†æˆ·é…ç½®ï¼ˆapikey/promptï¼‰<br/>- æ•°æ®æºé…ç½®<br/>- TTL=24hé…ç½®]:::data
        CP[Context Pool<br/>- 24hå†…å­˜ç¼“å­˜<br/>- ä¼šè¯ä¸Šä¸‹æ–‡å…±äº«<br/>- è‡ªåŠ¨è¿‡æœŸæ¸…ç†]:::data
        KB[Knowledge Base<br/>- æœ¬åœ°æ•°æ®/äº‘æ•°æ®åº“<br/>- å…³é”®è¯æ£€ç´¢<br/>- æƒé‡æ’åº]:::data
        DB[User Log DB<br/>- ç”¨æˆ·æ˜ç»†è¡¨user_logs<br/>- 24hè‡ªåŠ¨æ¸…ç†<br/>- ä¸šåŠ¡ç»Ÿè®¡]:::data
    end

    %% ç¬¬äº”å±‚ï¼šåŸºç¡€è®¾æ–½å±‚
    subgraph Infra Layer [åŸºç¡€è®¾æ–½å±‚]
        VS[Voice Service<br/>- ASRï¼ˆæ™ºè°±/åƒé—®ï¼‰<br/>- TTSè¯­éŸ³åˆæˆ<br/>- 60ç§’è¯­éŸ³é™åˆ¶]:::infra
        LLMS[LLM Service<br/>- ä¸»å¤‡æ¨¡å‹è½®æ¢<br/>- å›å¤æ¶¦è‰²<br/>- é—²èŠç”Ÿæˆ]:::infra
    end

    %% æ•°æ®æµå‘
    U --> FE
    FE --> GW
    GW --> DS
    DS --> D
    DS --> CS
    CS --> CP
    GW --> A
    A --> VS
    A --> CP
    A --> B
    B --> CP
    B --> C
    C --> KB
    C --> CP
    B --> VS
    B --> LLMS
    A --> D
    B --> D
    C --> D
    D --> DB
    B --> FE
    FE --> U

    %% å…³é”®æŠ€æœ¯æ ‡æ³¨
    note right of A: ASRæˆæœ¬<br/>åƒé—®0.00008/ç§’<br/>æ™ºè°±0.0002/ç§’
    note right of CP: TTL=86400ç§’<br/>ï¼ˆ24å°æ—¶ï¼‰
    note right of D: ä¸ä¾èµ–A/B/C<br/>ç‹¬ç«‹åˆå§‹åŒ–