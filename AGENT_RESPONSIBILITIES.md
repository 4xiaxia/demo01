# 🎭 Agent 职责划分：临时工小分队的精确分工

> **核心原则**: 一个萝卜一个坑，各司其职，互不干扰

---

## 👥 **四个 Agent 的职责**

### Agent A - 前台接待员 📝

**职责**: 接收、分类、精简

```
用户输入
  ↓
A的工作:
  1. ASR转文字（如果是语音）
  2. 意图分类（PRICE_QUERY / INFO_QUERY / CHITCHAT）
  3. 问题精简（"东里村景区门票多少钱啊？" → "门票价格"）
  4. 丢入池子
  5. @B "有新任务了"
  ↓
完成，下班
```

**不负责**:

- ❌ 不回答问题
- ❌ 不查知识库
- ❌ 不做决策
- ❌ 不润色内容

---

### Agent B - 前台嘴巴 💬

**职责**: 决策、润色、回复

```
收到A的通知
  ↓
B的工作流程:

1️⃣ 查用户历史缓存（UUID）
   - 命中 → 直接返回 ✅
   - 未命中 → 继续

2️⃣ 查商户热门问题
   - 命中 → 直接返回 ✅
   - 未命中 → 继续

3️⃣ 判断意图

   如果是 CHITCHAT（闲聊）:
     ✅ B自己处理
     ✅ 查看上下文（池子里的历史）
     ✅ 用AI生成温柔回复
     ✅ 引导用户问业务问题
     ✅ 不需要问C

   如果是 PRICE_QUERY / INFO_QUERY（业务问题）:
     ✅ @C "帮我查一下知识库"
     ✅ 等C返回答案
     ✅ 润色C的答案（结合上下文）
     ✅ 回复用户

4️⃣ 如果C也没找到
   - 用AI兜底
   - 生成温柔的"不知道"回复
   - 建议联系工作人员

5️⃣ 写回复到池子
   - 保存到24h缓存
   - 下次相同问题直接命中

6️⃣ 回复用户
   - 文字 + TTS语音（如果用户是语音输入）
```

**核心能力**:

- ✅ **润色**: C 给的答案可能生硬，B 要润色得温柔
- ✅ **闲聊**: A 判断是闲聊，B 自己聊，不麻烦 C
- ✅ **上下文**: 结合池子里的历史，让回复更自然
- ✅ **决策**: 先查缓存，再问 C，最后 AI 兜底

**不负责**:

- ❌ 不做 ASR（A 做）
- ❌ 不检索知识库（C 做）
- ❌ 不记录日志（D 做）

---

### Agent C - 图书管理员 📚

**职责**: 检索知识库，返回答案

```
收到B的查询请求
  ↓
C的工作:

1️⃣ 检索知识库
   - 关键词匹配
   - 标题匹配
   - 内容匹配

2️⃣ 如果命中多条
   - 查看池子（用户上下文）
   - 用AI理解用户真正想问什么
   - 选择最佳答案

3️⃣ 返回给B
   - 找到 → 返回答案
   - 未找到 → 通知B "没找到"

4️⃣ 通知D
   - 成功 → 记录命中
   - 失败 → 报缺
```

**核心能力**:

- ✅ **检索**: 快速匹配关键词
- ✅ **智能选择**: 多结果时用 AI 理解上下文
- ✅ **只读不写**: 只查池子，不写池子（B 负责写）

**不负责**:

- ❌ 不回复用户（B 负责）
- ❌ 不润色内容（B 负责）
- ❌ 不处理闲聊（B 负责）
- ❌ 不写缓存（B 负责）

---

### Agent D - 监控摄像机 📹

**职责**: 全程录像，统计报缺

```
系统启动
  ↓
D的工作:

1️⃣ 监听所有消息
   - bus.on('*') 监听全部
   - 记录每个Agent的动作
   - 统计耗时、成功率

2️⃣ 健康检查
   - 检查ABC是否正常
   - 超时告警

3️⃣ 报缺收集
   - C未找到答案 → 记录
   - 统计高频缺失问题
   - 提供给后台"报缺列表"

4️⃣ 写入MongoDB
   - 用户明细表（log队列）
   - 24小时后自动清理
```

**核心能力**:

- ✅ **全程录像**: 不漏掉任何消息
- ✅ **独立启动**: 不依赖 ABC
- ✅ **无侵入**: 只记录，不干预

**不负责**:

- ❌ 不参与业务逻辑
- ❌ 不回复用户
- ❌ 不查知识库

---

## 🎯 **典型场景演示**

### 场景 1: 业务问题（需要 C）

```
用户: "门票多少钱?"
  ↓
A:
  - ASR转文字 ✅
  - 意图分类: PRICE_QUERY ✅
  - 精简: "门票价格" ✅
  - @B "有新任务" ✅
  ↓
B:
  - 查用户历史 → 未命中
  - 查热门问题 → 未命中
  - 判断: PRICE_QUERY（业务问题）
  - @C "帮我查知识库: 门票价格" ✅
  ↓
C:
  - 检索知识库 ✅
  - 找到: "成人票60元/人，学生票30元/人..." ✅
  - 返回给B ✅
  ↓
B:
  - 收到C的答案
  - 润色: "您好！东里村景区成人票60元/人，学生票30元/人（需凭学生证），60岁以上老人免费（需凭身份证）。" ✅
  - 写入池子（24h缓存）✅
  - 回复用户 ✅
  ↓
D:
  - 全程录像 ✅
  - 记录: 来源=knowledge_base, 耗时=120ms ✅
```

---

### 场景 2: 闲聊（B 自己处理）

```
用户: "你好啊"
  ↓
A:
  - 意图分类: CHITCHAT ✅
  - @B "有新任务，是闲聊" ✅
  ↓
B:
  - 判断: CHITCHAT（闲聊）
  - 查看池子（用户历史）
  - 用AI生成温柔回复: "您好！我是东里村景区的智能导游助手，很高兴为您服务。您想了解景区的哪些信息呢？比如门票价格、开放时间、交通路线等，我都可以帮您解答哦~" ✅
  - 写入池子 ✅
  - 回复用户 ✅
  - ❌ 不需要问C！
  ↓
D:
  - 全程录像 ✅
  - 记录: 来源=chitchat, 耗时=80ms ✅
```

**为什么不问 C？**

- 闲聊不需要查知识库
- B 自己结合上下文就能聊
- 节省 C 的资源
- 响应更快

---

### 场景 3: 多轮对话（B 润色+上下文）

```
用户1: "东里村在哪?"
  ↓
A: LOCATION_QUERY → @B
  ↓
B: @C "查位置"
  ↓
C: 返回 "福建省莆田市..."
  ↓
B: 润色 + 回复用户 ✅
  ↓
用户2: "那边门票多少钱?"
  ↓
A: PRICE_QUERY → @B
  ↓
B:
  - 查看池子（用户刚问过"东里村在哪"）
  - 理解: "那边" = "东里村"
  - @C "查东里村门票价格"
  ↓
C:
  - 查看池子（确认上下文）
  - 用AI理解: "那边" → "东里村"
  - 检索知识库 ✅
  - 返回答案
  ↓
B:
  - 润色: "东里村景区成人票60元/人..." ✅
  - 回复用户 ✅
```

**B 的润色能力**:

- 结合上下文（知道用户刚问过东里村）
- 让回复更自然（不是生硬的"成人票 60 元"）
- 引导用户（"还想了解其他信息吗？"）

---

## 💡 **为什么这样设计**

### 1. **B 是嘴巴，专注沟通**

```
传统设计:
  C返回 → 直接给用户
  ❌ 答案生硬
  ❌ 没有温度
  ❌ 不结合上下文

你的设计:
  C返回 → B润色 → 给用户
  ✅ 答案温柔
  ✅ 有人情味
  ✅ 结合上下文
```

### 2. **闲聊不麻烦 C**

```
传统设计:
  闲聊 → C查知识库 → 没找到 → AI兜底
  ❌ 浪费C的资源
  ❌ 响应慢
  ❌ 成本高

你的设计:
  闲聊 → B直接处理
  ✅ 不查知识库
  ✅ 响应快
  ✅ 成本低
```

### 3. **各司其职，互不干扰**

```
A: 只负责分类，不回答
B: 只负责回复，不检索
C: 只负责检索，不回复
D: 只负责记录，不干预

✅ 职责清晰
✅ 易于维护
✅ 易于扩展
```

---

## 🎓 **总结**

### Agent B 的核心价值

**不是**:

- ❌ 简单的消息转发
- ❌ 被动的等待回复
- ❌ 机械的返回答案

**而是**:

- ✅ **智能决策**: 先查缓存，再问 C，最后 AI 兜底
- ✅ **温柔润色**: C 的答案可能生硬，B 要润色得有温度
- ✅ **上下文理解**: 结合池子里的历史，让回复更自然
- ✅ **闲聊处理**: A 判断是闲聊，B 自己聊，不麻烦 C

### 这就是"嘴巴"的艺术

```
C: "成人票60元"（生硬）
  ↓
B润色:
  "您好！东里村景区成人票60元/人，
   学生票30元/人（需凭学生证），
   60岁以上老人免费（需凭身份证）。
   还想了解其他信息吗？" ✅
```

**这就是 B 的价值：让 AI 有温度。** 💬
