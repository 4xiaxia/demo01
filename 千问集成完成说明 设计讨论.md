# ✅ 千问+上下文池集成完成！

> **实现时间**: 2026-01-12 19:40  
> **状态**: 可立即测试

---

## 📦 已完成的集成

### 1. 上下文缓存池 ✅
- **文件**: `src/core/context-pool.ts`
- **功能**: ABC Agent共享"黑板"机制
- **API**:
  - `addTurn()` - 添加对话轮次
  - `getRecentTurns()` - 获取历史
  - `buildAIContext()` - 构建千问上下文

### 2. 千问API集成 ✅               
- **文件**: `src/lib/qwen-api.ts`
- **模型**: Qwen2.5-7B-Instruct (硅基流动免费)
- **功能**: 工具调用 + 多轮对话
- **工具**:
  - `search_knowledge` - 搜索知识库
  - `get_context` - 获取历史对话

### 3. Agent A 升级 ✅
- **修改**: 写入用户问题到上下文池
- **位置**: `processInput()` 第5步
- **数据**: 用户原始输入 + 精简问题 + 意图 + 输入类型

### 4. Agent B 升级 ✅
- **修改**: 集成千问处理逻辑
- **功能**:
  - 检测指代词 (那边、这个、刚才...)
  - 调用千问理解上下文
  - 工具自动路由
  - 降级到普通AI
- **新方法**:
  - `needsContext()` - 检测指代词
  - `handleWithQwen()` - 千问处理

### 5. Agent C 升级 ✅
- **修改**: 暴露搜索方法
- **新API**: `search(query)` - 供千问工具调用
- **方法**: `smartSearch()` 改为public



# ————用户批改补充——————————
由于可能免费模型有限制，备用模型可以多个，env里的key测试可以用  qwen3-0.8  
---智谱也可以 4.5flash
千问也可以 


## 🔄 完整工作流程

# ————用户批改补充——————————黑板存24小时的即可缓存   数据库数据表需要有用户明细表（等于log队列日志队列流水线记录）

漏了：（判断前置，不用ai再判断）用户交互选择对话模式——文本模式：出现的是对话输入框的
————语音模式，就显示的是语音按钮而不是输入框
前端直接走成熟的ui框架快速搭建，成熟的框架细节处理得当

前端用用户发起提问——》专用url带了商家参数 ——>商户编码、用户uuid-当前时间-对话模式选择（必带参数）

四个扮演专业客服小分队 agent们此时：（用临时工比喻）小团队四人组接到订单电话—— xx商家房间坑——uuid用户语音工作- 
   |
   |
四人小组裸奔到商家坑进入房间——>穿上配置（apikey、prompt·各就各位）  上节课的黑板（历史的）也就位了，都看看各自自己的工具（敲黑板，action！）
队列池（log日志走起——商家的监工录像机）

模拟他们的工作：
B——加载配置的提示词，模型认知理解（给模型时间熟悉自己的cos和加载之前的log黑板）
D监控启动：人来了 ！（系统给D 发送本次发起的信息。这样万一A坏了，马上就会知道，而不该寄托A上，否则一旦bug，全线挂）

——>语音进入  —— A-> 用商家的语音key的模型 ——>问题和钱、价格有没有关系 **【重点还要加一个类；是不是废话和业务没关系的】 ——有or没（分类简化成这样）

——》简练问题（去掉废话）——>丢入缓存池 @B看池（流水线生产队思路ANP队列池，省token  按顺序，这样多用户来了，能有序不串台） 同时通知@D：A-ok 


//** （A的api补充说明：duff装备：多个可轮换   反正都一样读取，1个和10个其实没差  —— 商家自己看自己业务量    费用智谱有点坑，千问0.00008/秒   智谱0.0002/秒）语音需要限制单次60秒内。)

B——> 情况一：
收到A的滴滴——理解问题——>看队列——看缓存池黑板子有答案的：收到A的滴滴——>按照顺序队列加载(看24小时内缓存黑板和这个uuid) —— 语音的，调用配置的语音回复（自己润色回复，）——>回复的内容和uuid丢入缓存池（黑板）——报告D——ok
情况二： 
24小时缓存没这个问题，这个客户uuid也没来过/24小时内来过  问题丢入缓存池并@C 看池，@d——>问题给c了——等待c            //（黑板其实这个其实也就是聊天记录abcd共享的意思）
情况三：问价格的：认真回答
情况四：废话的，或者需要引导的和知识没关系的，温柔看着办，看上下文直接回答。—— 丢入池 -通知D 非业务相关问题  完毕ok了

C——> c收到@，看池的问题-检索 勾选热门的权重高。(这里看商家配置是用本地数据还是云数据库)搜索关键词——命中多个， ，@D命中多个 C看下池子结合上下文给B答案，@通知D ok了   （C不丢入缓存，让B丢入，C只看，C专心负责与知识相关的，给B最合适的答案，业务会话的完结应该是B做完结。所以b丢入缓存池子它的回复）
   D


### 场景1: 普通问题

```
用户: "东里村门票多少钱？"                              # 用户批改：  用户选择语音——agentA 调用模型——【读取商户配置】
  ↓
Agent A:
  - ASR识别 ✅
  - 意图分类: PRICE_QUERY ✅
  - 写入上下文池 ✅
  - 发送给B
  ↓
Agent B:
  - 查热门缓存 ❌ 未命中
  - needsContext() → false (无指代词)
  - 调用Agent C ✅
  ↓
Agent C:
  - 搜索知识库 ✅
  - 找到: "成人票65元"
  ↓
Agent B:
  - 生成TTS ✅
  - 回复用户 ✅
  - 写入上下文池 ✅
```

### 场景2: 指代词问题 (千问)

```
对话1:
用户: "东里村在哪里？"
回复: "福建省莆田市..."
[写入上下文池] ✅

对话2:
用户: "那边门票多少钱？" ← 有指代词
  ↓
Agent A:
  - 意图分类: PRICE_QUERY
  - 写入上下文池 ✅
  ↓
Agent B:
  - 查热门缓存 ❌
  - needsContext("那边") → true ✅
  - handleWithQwen() 启动 ✅
  ↓
千问处理:
  1. contextPool.buildAIContext() → 获取历史3轮 ✅
  2. 千问看到: ["用户: 东里村在哪", "助手: 福建..."] ✅
  3. 千问理解 "那边" = "东里村" ✅
  4. 千问调用 search_knowledge("东里村门票") ✅
  5. 获得结果: "成人票65元" ✅
  6. 生成回答 ✅
  ↓
Agent B:
  - 回复用户 ✅
  - 写入上下文池 ✅
```

---

## 🧪 测试步骤

### 1. 启动前端
```bash
npm run dev
```

### 2. 启动后端
```bash
npm run dev:server
```

### 3. 测试对话

**测试1: 普通问题**
```
问: "东里村门票多少钱?"
预期: 直接回答"成人票65元..."
```

**测试2: 多轮对话 (关键!)**
```
问1: "东里村在哪里?"
答1: "福建省莆田市..."

问2: "那边门票多少钱?" ← 检查是否理解"那边"
预期: "东里村成人票65元..." (千问自动理解)
```

**测试3: 复杂指代**
```
问1: "东里村开放时间?"
答1: "8:00-17:30"

问2: "门票呢?" ← 省略主语
预期: "东里村成人票65元..." (千问补全)

问3: "有优惠吗?" ← 继续省略
预期: 介绍优惠政策 (千问理解上下文)
```

---

## 📊 监控查看

访问 `http://localhost:5173/admin/monitor`

应该看到：
- ✅ **业务流日志**: 显示完整的 A→B→千问→用户 流程
- ✅ **输入类型统计**: voice/text 占比真实
- ✅ **报缺列表**: 真实数据（如果有未命中）
- ✅ **Agent健康状态**: 显示4个Agent状态

---

## 🎛️ 配置开关

在 `agent-b.ts` 中：
```typescript
private USE_QWEN = true;  // 设为false禁用千问
```

---

## 🔧 调试技巧

### 查看控制台日志

```javascript
// Agent A 写入上下文
[A哥] ✍️ 写入用户问题到上下文池

// Agent B 检测指代词
[B哥] 🧠 检测到指代词，使用千问理解...

// 千问工具调用
[B哥] 🔧 search_knowledge("东里村门票")
[Qwen] 🚀 调用千问API...
[Qwen] 🔧 AI决定调用工具: ['search_knowledge']
[Qwen] 🛠️ 执行工具: search_knowledge
[Qwen] ✅ 工具执行成功: {...}
[Qwen] 🎯 获得最终答案 (2轮)

// 成功回复
[B哥] ✅ 千问成功
```

###失败时
```javascript
[Qwen] ❌ API错误: 401 - Invalid API key
[B哥] ❌ 千问失败，降级
[B哥] 正在询问AI: "那边门票多少钱" ← 降级到普通AI
```

---

## 💡 已知问题

1. **硅基流动限流**: 免费版有QPS限制，高频使用可能被限流
2. **上下文窗口**: 只保留最近3轮对话，更早的会遗忘
3. **刷新丢失**: 上下文池在内存中，刷新页面会丢失

---

## 🚀 下一步优化

1. **上下文持久化**: 将上下文池存到localStorage
2. **智能摘要**: 超过10轮对话时，用AI总结历史
3. **工具扩展**: 添加天气、地图等新工具
4. **MCP迁移**: 将Agent改为标准MCP Server

---

## 📝 文件清单
（这里没更新文档，agent应该再服务端而不是前）
```
src/
├── core/
│   └── context-pool.ts       ← 上下文缓存池 NEW
├── lib/
│   └── qwen-api.ts           ← 千问API集成 NEW
├── agents/
│   ├── agent-a.ts            ← 写入上下文 MODIFIED
│   ├── agent-b.ts            ← 集成千问 MODIFIED
│   └── agent-c.ts            ← 暴露搜索 MODIFIED
```

---

**状态**: ✅ **可立即测试！**  
**核心功能**: 多轮对话 + 指代词理解 + 工具调用  
**免费额度**: 硅基流动无限调用（有QPS限制）

现在运行 `npm run dev`，试试问"那边门票多少钱"！



Dragonfly
## Command to connect to your Dragonfly

redis-cli -h cgk1.clusters.zeabur.com -p 23465 -a Y8Xh0mj6Zb7l5cI9zE2yCO4RKo31qPiw

## Dragonfly password

Y8Xh0mj6Zb7l5cI9zE2yCO4RKo31qPiw

## Redis host

cgk1.clusters.zeabur.com

## Redis port

23465



I've deployed a mongodb service on Zeabur. Here are the instructions: 

## Command to connect to your MongoDB

mongosh "mongodb://mongo:2ya61Cc5Psq4fb8Kg97N0wivBeEGn3SY@cgk1.clusters.zeabur.com:27187"

## MongoDB connection string

mongodb://mongo:2ya61Cc5Psq4fb8Kg97N0wivBeEGn3SY@cgk1.clusters.zeabur.com:27187

## MongoDB username

mongo

## MongoDB password

2ya61Cc5Psq4fb8Kg97N0wivBeEGn3SY

## MongoDB host

cgk1.clusters.zeabur.com

## MongoDB port

27187

## MongoDB database name
I've deployed a Dragonfly service on Zeabur. Here are the instructions: 

## Command to connect to your Dragonfly

redis-cli -h cgk1.clusters.zeabur.com -p 23465 -a Y8Xh0mj6Zb7l5cI9zE2yCO4RKo31qPiw

## Dragonfly password

Y8Xh0mj6Zb7l5cI9zE2yCO4RKo31qPiw

## Redis host

cgk1.clusters.zeabur.com

## Redis port

23465